<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta name="theme-color" content="#0C171C">
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <link rel="icon" type="image/png" href="/favicon-32x32.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
  <link href="https://fonts.googleapis.com/css2?family=Playball&amp;display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles/styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/styles/default.min.css">
  <link rel="stylesheet" href="/styles/monokai.css">

  <title>PHPUnit, Mocks and Closures</title>
  <meta content="Hello, I'm Brad Harris. I help build products with software, and love the web ❤️. I live in Castle Rock, Colorado and stay busy enjoying life with my family." name="description">

  
  <meta property="og:url" content="https://bradharris.dev/old-school/2011-05-28/phpunit-mocks-and-closures/">
  <meta property="og:title" content="PHPUnit, Mocks and Closures">
  
    <meta property="og:image" content="https://bradharris.dev/post-thumbnails/brad.jpg">
  
  
  
    <meta property="og:description" content="Hello, I'm Brad Harris. I help build products with software, and love the web ❤️. I live in Castle Rock, Colorado and stay busy enjoying life with my family.">
  
  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@selfc0ntained">
  <meta name="twitter:creator" content="@selfc0ntained">
  <meta name="twitter:title" content="PHPUnit, Mocks and Closures">
  
  
    <meta name="twitter:description" content="Hello, I'm Brad Harris. I help build products with software, and love the web ❤️. I live in Castle Rock, Colorado and stay busy enjoying life with my family.">
  
  
    <meta name="twitter:image" content="https://bradharris.dev/post-thumbnails/brad.jpg">
  
  
    <meta name="twitter:image:alt" content="Picture of Brad Harris">
  

  <script>
    (() => {
      // prevent flashing of light=>dark mode on load
      const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches
      const darkEnabled = localStorage.getItem('dark-mode')
      if(darkEnabled === "true" || (prefersDark && darkEnabled !== "false")) {
        document.documentElement.classList.toggle("dark-mode", true);
      }
    })();
  </script>
</head>
<body>
  <div id="main-layout">
    <header>
      <nav>
        <ul>
          <li><a href="/">bradharris.dev</a></li>
          <li><a href="/about/">about</a></li>
          <li><a href="/posts/">posts</a></li>
        </ul>
      </nav>
      <dark-mode-toggle key="dark-mode" darkmode-class="dark-mode">
    </dark-mode-toggle></header>


    <main class="post">
      
<h1>PHPUnit, Mocks and Closures</h1>
<time>May 28th, 2011</time>

<article><p>I like <a href="http://www.phpunit.de/manual/3.6/en/index.html">PHPUnit</a>, and I like <a href="http://us3.php.net/manual/en/functions.anonymous.php">closures</a>, but haven't found many useful cases for them (closures) in PHP yet.  Just recently I came across a situation where I needed a closure when working with PHPUnit Mock objects.  For those not familiar with Mock Objects in regards to testing, <a href="http://www.phpunit.de/manual/3.6/en/test-doubles.html#test-doubles.mock-objects">here's a link</a>.  It's fairly common when creating a mock object for testing to specify what a function is expected to be called with, and what it will return in that case.  Below I'm creating a mock 'User' object that will return 18 for the age however many times it is called.</p>
<pre><code class="language-php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">PHPUnit_Framework_TestCase</span></span>{

	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testGetAge</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-variable">$user</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getMock</span>(<span class="hljs-string">'User'</span>, <span class="hljs-keyword">array</span>(<span class="hljs-string">'getAge'</span>))
			-&gt;<span class="hljs-title function_ invoke__">expects</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">any</span>())
			-&gt;<span class="hljs-title function_ invoke__">method</span>(<span class="hljs-string">'getAge'</span>)
			-&gt;<span class="hljs-title function_ invoke__">will</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">returnValue</span>(<span class="hljs-number">18</span>));
		<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">assertTrue</span>(<span class="hljs-variable">$user</span>-&gt;<span class="hljs-title function_ invoke__">getAge</span>(), <span class="hljs-number">18</span>);
	}

}
</code></pre>
<p>This is a pretty straight forward example of Mocks, but what happens when the value you want to return is dependent on the value it is called with, and there is some logic required to process this?  This is where closures come in handy.  Let's say you have a dynamic array you've built up, and you want to return true if a particular function, <strong>hasValue</strong> is called with a value that exists in that array.  Here's how you can do it with <strong>Mocks</strong> and <strong>closures</strong>, using the <strong>returnCallback</strong> functionality of PHPUnit:</p>
<pre><code class="language-php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">PHPUnit_Framework_TestCase</span></span>{

	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testInArray</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-variable">$values</span> = <span class="hljs-keyword">array</span>(<span class="hljs-number">1</span>,<span class="hljs-number">10</span>,<span class="hljs-number">78</span>,<span class="hljs-number">30</span>);
		<span class="hljs-variable">$user</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getMock</span>(<span class="hljs-string">'User'</span>, <span class="hljs-keyword">array</span>(<span class="hljs-string">'hasValue'</span>))
			-&gt;<span class="hljs-title function_ invoke__">expects</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">any</span>())
			-&gt;<span class="hljs-title function_ invoke__">method</span>(<span class="hljs-string">'hasValue'</span>)
			-&gt;<span class="hljs-title function_ invoke__">with</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">anything</span>())
			-&gt;<span class="hljs-title function_ invoke__">will</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">returnCallback</span>(function(<span class="hljs-variable">$value</span>) <span class="hljs-keyword">use</span> (<span class="hljs-variable">$values</span>){
				<span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$value</span>, <span class="hljs-variable">$values</span>);
			}));
		<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">assertTrue</span>(<span class="hljs-variable">$user</span>-&gt;<span class="hljs-title function_ invoke__">hasValue</span>(<span class="hljs-number">10</span>));
		<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">assertTrue</span>(<span class="hljs-variable">$user</span>-&gt;<span class="hljs-title function_ invoke__">hasValue</span>(<span class="hljs-number">99</span>) == <span class="hljs-literal">false</span>);
	}

}
</code></pre>
<p>When I call <strong>hasValue</strong>, passing in 10, we'll get true, and with 99 it's false.  This is checked at runtime when the closure is executed, checking against the <strong>$values</strong> array.  Also, stay away from <a href="http://canvasrider.com/tracks/featured">Canvas Rider</a>, it's dangerously addictive.</p>
</article>
    </main>
    <footer>
      <span>© 2023 Brad Harris</span>
      <a href="https://twitter.com/selfc0ntained" rel="me"><img src="/icons/twitter.png" width="15" class="glow-2"></a>
      <a href="https://github.com/selfcontained" rel="me"><img src="/icons/github.png" width="15" class="glow"></a>
      <a href="https://www.linkedin.com/in/bradharris/" rel="me"><img src="/icons/linkedin.png" width="15" class="glow-3"></a>
      <dark-mode-toggle key="dark-mode" darkmode-class="dark-mode">
    </dark-mode-toggle></footer>
  </div>
  <script src="/scripts/dark-mode-toggle.js"></script>
  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-49NP8W3EPZ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-49NP8W3EPZ');
    </script>
  

</body></html>